{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps_1": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "mpa_MicrosoftPowerAcceleratorDataverse"
        },
        "runtimeSource": "embedded"
      },
      "shared_office365_1": {
        "api": {
          "name": "shared_office365"
        },
        "connection": {
          "connectionReferenceLogicalName": "mpa_MicrosoftPowerAcceleratorsOutlook"
        },
        "runtimeSource": "invoker"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "Mobile App Link (mpa_varmobileapplink)": {
          "defaultValue": "https://apps.powerapps.com/play/e/6c086a94-f4d8-e980-a0a6-97486898031c/a/e89d7cd5-b535-43c3-b699-6d8a0739acf2",
          "type": "String",
          "metadata": {
            "schemaName": "mpa_varmobileapplink",
            "description": "To hold the link to the Shift Planner mobile app"
          }
        }
      },
      "triggers": {
        "manual": {
          "type": "Request",
          "kind": "PowerAppV2",
          "inputs": {
            "schema": {
              "type": "object",
              "properties": {
                "date": {
                  "title": "Week Start Date",
                  "type": "string",
                  "format": "date",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter or select a date (YYYY-MM-DD)",
                  "x-ms-content-hint": "DATE"
                },
                "date_1": {
                  "title": "Week End Date",
                  "type": "string",
                  "format": "date",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter or select a date (YYYY-MM-DD)",
                  "x-ms-content-hint": "DATE"
                },
                "text": {
                  "title": "Zone",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Please enter your zone id",
                  "x-ms-content-hint": "TEXT"
                },
                "text_1": {
                  "title": "Action",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Publish/Unpublish",
                  "x-ms-content-hint": "TEXT"
                },
                "text_2": {
                  "description": "Please enter the User Id to update records, use zone or user mode",
                  "title": "UserId",
                  "type": "string",
                  "x-ms-content-hint": "TEXT",
                  "x-ms-dynamically-added": true
                }
              },
              "required": [
                "date",
                "date_1",
                "text",
                "text_1",
                "text_2"
              ]
            }
          },
          "metadata": {
            "operationMetadataId": "bf99ed77-b473-4541-853b-eb9ddeb0cb74"
          }
        }
      },
      "actions": {
        "Get_Assigned_Users": {
          "type": "OpenApiConnection",
          "description": "Get all users assigned for the specified week",
          "inputs": {
            "parameters": {
              "entityName": "mpa_shiftplanner_shiftbookings",
              "$select": "mpa_resource",
              "$filter": "@{outputs('Generate_Filter_Prefix')} and mpa_date ge @{triggerBody()['date']} and mpa_date le @{triggerBody()['date_1']} and statecode eq 0",
              "$orderby": "mpa_date",
              "$expand": "mpa_resource"
            },
            "host": {
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
              "operationId": "ListRecords",
              "connectionName": "shared_commondataserviceforapps_1"
            }
          },
          "runAfter": {
            "Generate_Filter_Prefix": [
              "SUCCEEDED"
            ]
          },
          "metadata": {
            "operationMetadataId": "8ed72658-9ceb-43cb-abfa-99e9df019083"
          }
        },
        "Select_Resource_Email": {
          "type": "Select",
          "description": "Select only the resources' emails",
          "inputs": {
            "from": "@outputs('Get_Assigned_Users')?['body/value']",
            "select": {
              "Resource Email": "@item()?['mpa_resource/internalemailaddress']"
            }
          },
          "runAfter": {
            "Initialize_EmailBody": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "f0920fab-243f-4a61-829d-a981e887bf19"
          }
        },
        "Get_Unique_Resources": {
          "type": "Compose",
          "description": "Get unique users",
          "inputs": "@union(body('Select_Resource_Email'),body('Select_Resource_Email'))",
          "runAfter": {
            "Select_Resource_Email": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "06cb642a-7649-4ddf-a834-cca3fca24fc8"
          }
        },
        "For_Each_User": {
          "type": "Foreach",
          "foreach": "@outputs('Get_Unique_Resources')",
          "actions": {
            "Send_published_notification": {
              "type": "OpenApiConnection",
              "description": "Send each user an email notification about published/unpublished week status",
              "inputs": {
                "parameters": {
                  "emailMessage/To": "@items('For_Each_User')?['Resource Email']",
                  "emailMessage/Subject": "@replace(\r\n    replace(variables('EmailSubject'), \r\n    '[First Day of Week]', \r\n    outputs('Format_Start_Date')),\r\n'[Last Day of Week]', \r\noutputs('Format_End_Date'))",
                  "emailMessage/Body": "<p>@{replace(\r\n    replace(variables('EmailBody'), \r\n    '[First Day of Week]', \r\n    outputs('Format_Start_Date')),\r\n'[Last Day of Week]', \r\noutputs('Format_End_Date'))} <a href=\"@{parameters('Mobile App Link (mpa_varmobileapplink)')}\">Shift Planner Mobile Application</a>.</p>",
                  "emailMessage/Importance": "Normal"
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365",
                  "operationId": "SendEmailV2",
                  "connectionName": "shared_office365_1"
                }
              },
              "metadata": {
                "operationMetadataId": "bacf023d-7727-4cae-82aa-70c13985439f"
              }
            }
          },
          "runAfter": {
            "Set_EmailBody": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "958d2c8b-3b50-4f6a-9049-050d7cf6a1c1"
          }
        },
        "Format_Start_Date": {
          "type": "Compose",
          "description": "Format the start to MMMM dd",
          "inputs": "@formatDateTime(triggerBody()['date'],'MMMM dd')",
          "runAfter": {
            "Get_Unique_Resources": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "2fe12296-ea30-49a0-a133-97dbaedd8dbf"
          }
        },
        "Format_End_Date": {
          "type": "Compose",
          "description": "Format the end date to MMMM dd, yyyy",
          "inputs": "@formatDateTime(triggerBody()['date_1'],'MMMM dd, yyyy')",
          "runAfter": {
            "Format_Start_Date": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "3d6ff7ff-c6f3-4288-b62e-b4765f275ec1"
          }
        },
        "Check_if_Publish_or_Unpublish": {
          "type": "If",
          "expression": {
            "equals": [
              "@triggerBody()['text_1']",
              "Publish"
            ]
          },
          "actions": {
            "Set_Publish_EmailTemplateName": {
              "type": "SetVariable",
              "description": "If publish, set Email Template name to the Published email template",
              "inputs": {
                "name": "EmailTemplateName",
                "value": "Published Schedule (Weekly)"
              },
              "metadata": {
                "operationMetadataId": "e0d64c7e-a7f1-487e-8010-4618012695a1"
              }
            }
          },
          "else": {
            "actions": {
              "Set_Unpublish_EmailTemplateName": {
                "type": "SetVariable",
                "description": "If unpublish, set Email Template name to Unpublished email template",
                "inputs": {
                  "name": "EmailTemplateName",
                  "value": "Unpublished Schedule (Weekly)"
                },
                "metadata": {
                  "operationMetadataId": "9f21c46a-cfcc-4703-9a70-2f7e3038b7bd"
                }
              }
            }
          },
          "runAfter": {
            "Format_End_Date": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "c0c77336-c091-4087-8adc-fa5643c0148d"
          }
        },
        "Initialize_EmailSubject": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "EmailSubject",
                "type": "string"
              }
            ]
          },
          "runAfter": {
            "Initialize_EmailTemplateName": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "1751551d-3b06-4741-8153-eace8a61de98"
          }
        },
        "Initialize_EmailBody": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "EmailBody",
                "type": "string"
              }
            ]
          },
          "runAfter": {
            "Initialize_EmailSubject": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "86e0b14c-d1b9-4a7b-a2b6-82d160feab5a"
          }
        },
        "Initialize_EmailTemplateName": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "EmailTemplateName",
                "type": "string"
              }
            ]
          },
          "runAfter": {
            "Get_Assigned_Users": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "1d7529d1-a58d-4ab3-b764-a4cb9098b090"
          }
        },
        "Get_Email_Template": {
          "type": "OpenApiConnection",
          "description": "Get email template based on whether action is publish or unpublish",
          "inputs": {
            "parameters": {
              "entityName": "mpa_shiftplanner_emailtemplates",
              "$select": "mpa_subject, mpa_body",
              "$filter": "mpa_name eq '@{variables('EmailTemplateName')}'",
              "$top": 1
            },
            "host": {
              "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
              "operationId": "ListRecords",
              "connectionName": "shared_commondataserviceforapps_1"
            }
          },
          "runAfter": {
            "Check_if_Publish_or_Unpublish": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "0acbf7f4-a5a7-4b03-9ed1-bef8e1baf293"
          }
        },
        "Set_EmailSubject": {
          "type": "SetVariable",
          "description": "Set Subject Template to email subject",
          "inputs": {
            "name": "EmailSubject",
            "value": "@{first(body('Get_Email_Template')?['value'])?['mpa_subject']}"
          },
          "runAfter": {
            "Get_Email_Template": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "ef958dab-cde3-432f-8f31-55f4b6d72ea7"
          }
        },
        "Set_EmailBody": {
          "type": "SetVariable",
          "description": "Set Email Template to email body",
          "inputs": {
            "name": "EmailBody",
            "value": "@{first(body('Get_Email_Template')?['value'])?['mpa_body']}"
          },
          "runAfter": {
            "Set_EmailSubject": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "be4b1503-c0d0-44b3-b415-99beaffff512"
          }
        },
        "Generate_Filter_Prefix": {
          "type": "Compose",
          "inputs": "@if(\r\n  empty(triggerBody()?['text_2']), \r\n  concat('_mpa_zone_value eq ''', triggerBody()['text'], ''''), concat('_mpa_resource_value eq ''', triggerBody()['text_2'], ''''))",
          "runAfter": {}
        }
      },
      "description": "Flow that sends an email notification that a week's set of shifts has been published or unpublished to the assigned resources."
    },
    "templateName": null
  },
  "schemaVersion": "1.0.0.0"
}